---
title: "如何从SD卡自动启动应用程序"
permalink: /tech/sd-startup/
excerpt: "这篇文章分享如何设置操作系统自动从SD卡启动应用程序."
modified: 2016-11-15T18:58:02-04:00
---

{% include base_path %}
{% include toc %}

## 简介

大家可能会经常遇到，有时需要把一段应用程序代码放在SD卡上面，当系统开机的时候，自动加载该段程序代码，今天就来分析一下这个功能应该怎样实现。

该例程基于OpenWRT操作系统。

## 分析

该功能的实现可以分为几个部分，一是增加一个开机启动服务，该服务的目的是每当开机之后，就运行一个可以检查sd卡内文件的脚本。第二个就是开机启动运行的那个脚本。第三个就是需要放置在SD卡内的文件。

## 开机启动服务

这部分代码类似于[树莓派开机启动](http://diyjob.cc/blog/tech/startup-script/)那篇文章讲解的一样。代码也很相似。

```shell

#!/bin/sh /etc/rc.common
# Copyright (C) 2015 OpenWrt.org

START=99

start()
{
	[ -f /root/autorun.sh ] && /root/autorun.sh
}

``` 

上面这个脚本的作用，就是在开机的时候启动root目录下面的autorun.sh文件。把上面的代码保存为名为autorun的文件。


### 1. 把‘autorun’ 复制到‘/etc/init.d’

```shell
sudo cp autorun /etc/init.d
```

### 2. 设置文件为可执行文件

```shell
sudo chmod +x /etc/init.d/autorun
```

### 3. 设置开机启动

```shell
/etc/init.d/autorun enable

```


## 维护线程

在上面的步骤中可以看到，开机启动服务执行的是autorun.sh文件中的内容，那么这个文件里的内容如下面的代码所示

```shell

#!/bin/sh

while true
do 
    echo "wait for mounting sd card"
    while [ ! -f /tmp/run/mountd/mmcblk0p1/autorun ]; do
        sleep 1
    done

    echo "run autorun script on sd card"
    sh /tmp/run/mountd/mmcblk0p1/autorun &

    echo "wait for removing sd card"
    while [ -f /tmp/run/mountd/mmcblk0p1/autorun ]; do
        sleep 3
    done
done

```

这段shell脚本是一直都在运行的。/tmp/run/mountd/mmcblk0p1/ 这个目录就是挂载的SD卡的目录，用户可以把这个路径换成自己的SD卡路径。autorun文件就是放置在SD卡内的另一个启动脚本。它的作用就是启动存储在SD卡内的程序。

当没有找到SD卡内的autorun文件时，就是一直陷入延时为1s的循环。如果找到了，则启动SD卡内的autorun文件。

## 最后一步

前面我们已经完成了两个部分，最后一步就是执行SD卡内的一个脚本autorun。这个文件的代码很简单，如下所示。

```shell

#!/bin/sh

cd /tmp/run/mountd/mmcblk0p1/
python main.py &> /dev/console &

```

切换到需要执行的文件的目录，这里就是指挂载的SD卡的目录，示例中使用python脚本写的一段程序。所以直接用python来启动，并且程序的输出重定向到终端。

## 总结

这一节还是比较简单的内容，前段时间自己太懒了，好久不写东西了，后面我将分享一个有趣的东西。